<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Github web page for ECE 5160: Fast Robots (2023SP)." />
        <meta name="author" content="Zhongqi Tao (zt88@cornell.edu)" />
        <title>Fast Robots: Lab 7</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">ECE 5160 Â· Fast Robots</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="about.html">About Me & Project</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Page Header-->
        <header class="masthead" style="background-image: url('assets/img/post-bg.jpg')">
            <div class="container position-relative px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="post-heading">
                            <h1>Lab7:</h1>
                            <h1> Kalman Filter </h1>
                            <h2 class="subheading">Sensor Fusion</h2>
                            <span class="meta">
                                Posted by
                                <a href="about.html">Zhongqi Tao</a>
                                on March 21, 2023
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Post Content-->
        <article class="mb-4">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        
                        <p> The objective of Lab 7 is to implement a Kalman Filter, which can help to execute PID control faster. The Kalman Filter can supplement the slowly sampled ToF values, so that the robot can speed towards the wall as fast as possible. This report describes how I decide the parameters for the Kalman filter and after that, I implemented it with the PID data collected from lab 6 to verify its performance.</p>
                        <p> </p>
                        
                        
                        <p></p>
                        <h1> Lab Tasks </h1> 
                        
                        
                        <p></p>
                        <p></p>

                        <h2 class="section-heading">Estimate drag and momentum</h2>
                        <p> Kirstin's <a href="https://cei-lab.github.io/FastRobots-2023/lectures/FastRobots-14-LocalPlanning_and_Maps.pdf" class="link-primary">lecture</a> gives detailed explanation on Kalman filter. To design a Kalman filter for my own robot, I need to build a state space model for the system by estimating the drag and momentum terms for the A and B matrices, as shown below</p>
                        state space equation
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        <p> where d is drag term and m is momentum term.</p>
                        <p> </p>
                        drag and momentum
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        <p>I get these values using step response, which is to drive the robot towards the wall, recording the data including PWM, distance sensor readings and timestamps during the process, try to get the robot run at a steady state for a while with maximum speed from PID control in lab 6, eventually brake the robot by reverse spinning for a short time to counteract to inertance hence to prevent the robot hits the wall.</p>
                        
                        <p> I start the step response measurement by placing my robot at around 1600 mm away from the wall and I delay it for 2 seconds before setting the PWM to be 50% duty cycle which is the highest PWM I obtained from my PID control in lab 6. Eventually, the robot will keep moving forward until the distance is less than 200 mm when robot brakes actively. With constant PWM signal, the steady state appears when the robot stops accelerating and run at a constant speed. During the whole process, the data are collected and stored in arrays, and are sent to computer side via bluetooth at the end. </p>
                        
                        <p> To conclude, the step response measurement process is: </p>
                        
                        <p>     1. 2 seconds of stationary state for robot, with "constant" distance reading of around 1600 mm and PWM duty cycle percentage of 0. </p>
                        
                        <p>     2. Moving forward until ToF reading is less than 200 mm during which the PWM value is 50%. </p>
                        
                        <p>     3. Brake actively and stop for 1 second during which the distance reading is "constant" and PWM value drops back to 0. </p>
                        
                        <p> The distance measurement is plotted as below, which shows the distance between robot and wall during the whole step response measurement process. </p>
                        
                        <p> </p>
                        step_response_dist
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        <p> Similarly, the PWM duty cycle percentage is shown below. </p>
                        
                        <p> </p>
                        step_response_PWM
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        <p> Then, according to the distance measurements and timestamps, the velocity can be computed and plotted as below. </p>
                        
                        <p> </p>
                        velocity
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        <p> Since the robot starts to move after two seconds, the velocity shown before 2 seconds are actually results from the distance measurement errors when robot is stationary. So we are interested in the velocity after 2 seconds, where the velocity continues increasing and keeps constant for a short period at around 1.6 m/s before the robot stops. By processing the velocity data in python, I can get the steady state velocity to be 1564 mm/s and the 90% rise time to be 1.516s. </p>
                        
                        <p> Therefore, based on the step response data I obtain, I can compute drag and momentum terms based on the fomula before as: </p>
                        
                        <p> </p>
                        drag & momentum
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        <p> Now, I have my A and B matrices to be: </p>
                        
                        <p> </p>
                        A&B matrices
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> </p>
                        
                        
                        
                        
                        
                        <p></p>
                        <p> According to the experiments from previous labs, the robot will not move if PWM duty cycle is less than 25%, therefore a duty cycle percentage limit function is defined to ensure a reasonable value to be set for PWM. If the duty cycle percentage computed by PID is greater than 100, it will be set as 100 meaning full duty cycle of PWM. If it is computed less than 25, it will be set as 25 to keep robot moving. </p>
                        
                        <p> I code some helper functions to help control the motor more efficiently. </p>
                        <p> </p>
                        <script src="https://gist.github.com/zt88/3b8f59ed3b84603fdfad41927133a69d.js"></script>
                        
                        
                        <p></p>
                        <h2 class="section-heading">Range & Sampling time Discussion</h2>
                        <p> Based on the tests from previous labs, we have known that the sampling frequency of ToF sensor is around 20 Hz. During the tests of PID control, an interesting phenomenon is found that because of inertance and sampling frequency limitation, the vehicle may pass the 304 mm targeted stop distance. Therefore, a condition is added to ensure that if the distance reading is less than 304 mm, in which case the error becomes negative, the PID controller computed PWM duty cycle percentage value is reversed and allocated to backward function to make the robot move backward, hence looping around the stop line until the robot stops exactly when distance reading is 304 mm. </p>
                        
                        
                        <p> Another problem is that, since I am implementing short distance mode on the ToF sensor because of its better ambient disturbance immunity, the effective sensor reading range is upto around 1.4 meters and if the distance we are trying to measure is longer, the sensor reading just becomes zero. However, we may start the robot even further away from the wall, which leads to limitation of the sensor reading. To address the problem, while consiering effectiveness of PID control implementation, I eventually adjust the distance mode of front distance sensor to <code>Long</code>, so that we can get effective sensor readings away from the wall upto 4 meters. </p>
                        
                        
                        
                        
                        <h2 class="section-heading">Position Control Demonstration</h2>
                        <p> Video below demonstrates the robot successfully stops at around 304 mm away from the wall eventually. </p>
                        
                        <p></p>
                        
                        <iframe width="640" height="360" src="https://www.youtube.com/embed/1OEqv3JYsdo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        
                        <p></p>
                        <p> The distance sensor reading plot shows the distance between the robot and the wall during the task. </p>
                        <p></p>
                        <img src="lab6_imgs/distance.png" style="width:100%">
                        
                        <p></p>
                        <p></p>
                        <p> The time v.s. PWM duty cycle percentage plot is shown following. </p>
                        <p></p>
                        <img src="lab6_imgs/PWM.png" style="width:100%">
                        <p> The long time of 25 percent duty cycle is because the robot is close to the wall so that PID gives the lowest speed to robot, and when the robot is moving forward and backward to find the exact 304 mm reading, the PWM is always 25 percent. When it finally finds the 304 mm stop point, PID is stopped and PWM is set to 0. </p>

                        
                        
                        <p></p>
                        <p></p>
                        <p></p>
                        
                        <h1> Additional Tasks </h1> 
                        <h2 class="section-heading">Wind-up Implementation & Discussion </h2>
                        <p> Wind-up protection is implemented to protect the integrator in the PID control from being too large to affect the PID permormance. Since the integrator part of PID is a mathematical operation that performs the integration of a function with respect to time, its value can accumulate to be quite large as time goes, which can affect the PID outcome significantly with a long time integration. Therefore, I set a saturation point for my integration part as shown below. </p>
                        <p></p>
                        <script src="https://gist.github.com/zt88/0d064c5aeee78f037c570233809819ab.js"></script>
                         <p></p>
                        
                        <p> When error integration becomes greater than or equal to 10000, it equals to 10000 constantly. As my Ki is 0.0001, it only contributes 1 percent to my PWM duty cycle percentage, hence to avoid negative impact on PID output. </p>
                        

                        
                        <p></p>
                        <p>
                            Texts and Videos by
                            <a href="about.html">Zhongqi Tao</a>
                        </p>
                    </div>
                </div>
            </div>
        </article>
        <!-- Footer-->
        <footer class="border-top">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <ul class="list-inline text-center">
                            <li class="list-inline-item">
                                <a href="https://github.com/zt88/Fast-Robots">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                        </ul>
                        <div class="small text-center text-muted fst-italic">Copyright &copy; Fast Robots 2023</div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
